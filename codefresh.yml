version: '1.0'
steps:
  build:
    type: build
    title: Build Docker Image
    dockerfile: Dockerfile
    image_name: platform/${{CF_REPO_NAME}}
    build_arguments:
      - build=${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}
      - commit=${{CF_REVISION}}

  tag_branch:
    type: push
    title: Push docker image as branch
    candidate: ${{build}}
    registry: gladly
    tags:
      - ${{CF_BRANCH_TAG_NORMALIZED}}

  tag_latest:
    type: push
    title: Tag master as latest
    candidate: ${{build}}
    tags:
      - latest
      - ${{CF_REVISION}}
    registry: gladly
    when:
      branch:
        only:
          - master
